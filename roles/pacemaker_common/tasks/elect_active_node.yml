---
# -------------------------------------------------------
# REUSABLE TASK: ELECT ACTIVE CLUSTER NODE
# Description: Identifies a node where Pacemaker is running 
#              to serve as the execution point for global commands.
# Output: Sets variable 'active_cluster_node'
# -------------------------------------------------------

- name: "Election: Check Pacemaker Service Status (All Nodes)"
  command: systemctl is-active pacemaker
  register: pacemaker_service_check
  changed_when: false
  failed_when: false
  check_mode: false # Always run this, even in --check mode

- name: "Election: Designate Active Node"
  run_once: true
  set_fact:
    active_cluster_node: "{{ item }}"
  loop: "{{ ansible_play_hosts }}"
  when: 
    - active_cluster_node is not defined
    - "hostvars[item]['pacemaker_service_check'].rc == 0"

- name: "Election: Safety Fallback"
  run_once: true
  set_fact:
    active_cluster_node: "{{ ansible_play_hosts[0] }}"
    active_node_election_failed: true
  when: active_cluster_node is not defined

- name: "Election: Debug Winner"
  run_once: true
  debug:
    msg: "Selected Active Node: {{ active_cluster_node }}"
