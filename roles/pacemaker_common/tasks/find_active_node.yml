---
# 1. Health Check
- name: "Health Check: Verify cluster daemon is running"
  ansible.builtin.command: "pcs cluster status"
  register: cluster_health
  changed_when: false

# 2. Query Pacemaker
- name: "Ask Pacemaker: Is this specific node the Designated Controller?"
  ansible.builtin.shell: |
    set -o pipefail
    pcs status | grep 'Current DC:' | grep -w -q $(crm_node -n)
  args:
    executable: /bin/bash
  register: dc_check
  changed_when: false
  failed_when: dc_check.rc not in [0, 1]

# 3. Set a persistent Fact for this node
- name: "Set fact: is_active_node"
  ansible.builtin.set_fact:
    # If the grep command succeeded (rc == 0), this node is active.
    is_active_node: "{{ true if dc_check.rc == 0 else false }}"
