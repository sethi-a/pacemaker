---
# roles/find_active_node/tasks/main.yml

# 1. Health Check
- name: "Health Check: Verify cluster daemon is running"
  ansible.builtin.command: "pcs cluster status"
  register: cluster_health
  changed_when: false

# 2. Query Pacemaker
- name: "Ask Pacemaker: Is this specific node the Designated Controller?"
  ansible.builtin.shell: |
    set -o pipefail
    pcs status | grep 'Current DC:' | grep -w -q $(crm_node -n)
  args:
    executable: /bin/bash
  register: dc_check
  changed_when: false
  failed_when: dc_check.rc not in [0, 1]

# 3. Set a persistent Fact for this node
- name: "3. Get the Active Cluster Node (Designated Controller)"
  # crm_mon -1 prints the cluster status once. awk extracts just the node name.
  ansible.builtin.shell: "crm_mon -1 | awk '/Current DC:/ {print $4}'"
  register: active_node_cmd
  changed_when: false

- name: "Set fact: is_active_node"
  ansible.builtin.set_fact:
    # If the grep command succeeded (rc == 0), this node is active.
    is_active_node: "{{ true if dc_check.rc == 0 else false }}"
    active_cluster_node: "{{ active_node_cmd.stdout | trim }}"

- name: "5. Debug: Print Active Node and Local Node Names"
  ansible.builtin.debug:
    msg: "Active Cluster Node: {{ active_cluster_node }}, Is Active Node: {{ is_active_node }}"