---
# 1. Find the active cluster node
- name: "Find the Active Cluster Node"
  block:
    - name: "Step: Determine Active Cluster Node"
      include_role:
        name: pacemaker_common
        tasks_from: elect_active_node

# 2. Main Logic Block (Runs ONLY on the Active Node)
- name: "Pacemaker Remediation Logic"
  when: inventory_hostname == active_cluster_node
  block:
    # STEP A: Check for failures
    - name: "Check for Pacemaker resource failures"
      ansible.builtin.shell: "{{ pacemaker_check_command }}"
      register: crm_mon_output
      changed_when: false
      failed_when: false 

    # STEP B: Display Summary
    - name: "Display resource failure summary"
      ansible.builtin.debug:
        msg: "Failures detected on {{ inventory_hostname }}. Proceeding to cleanup."
      when: crm_mon_output.stdout | length > 0

    # STEP C: Attempt Primary Cleanup
    # This task only runs if Step A found errors.
    # If this task FAILS, it triggers the 'rescue' section.
    - name: "Execute 'pcs resource cleanup'"
      ansible.builtin.command: pcs resource cleanup
      register: pcs_cleanup_out
      failed_when: pcs_cleanup_out.rc != 0
      when: crm_mon_output.stdout | length > 0

    - name: "Display Primary Cleanup Success"
      ansible.builtin.debug:
        msg: "Primary cleanup succeeded."
      when: 
        - crm_mon_output.stdout | length > 0
        - pcs_cleanup_out.rc == 0

  # 3. Rescue Block (Triggered ONLY if 'pcs resource cleanup' fails)
  rescue:
    # - name: "Execute Secondary Cleanup (crm_resource)"
    #   ansible.builtin.shell: |
    #     for resource in $(crm_mon -1 -r | grep -i "failed" | awk '{print $NF}'); do
    #         crm_resource --cleanup --resource $resource
    #     done
    #     # Fallback global cleanup
    #     crm_resource --cleanup
    #   register: rescue_cleanup_out

    - name: "Display Rescue Result"
      ansible.builtin.debug:
        msg: "Rescue operation completed. Please verify cluster status."