---
# 1. Find the active cluster node
- name: "Find the Active Cluster Node"
  block:
    - name: "Step: Determine Active Cluster Node"
      include_role:
        name: pacemaker_common
        tasks_from: elect_active_node

# 2. Main Logic Block (Runs ONLY on the Active Node)
- name: "Pacemaker Remediation Logic"
  when: inventory_hostname == active_cluster_node
  block:
    # 1. Check for failures
    - name: "Check for Pacemaker resource failures"
      ansible.builtin.shell: "{{ pacemaker_check_command }}"
      register: crm_mon_output
      changed_when: false
      failed_when: false 

    # 2. Normalize the output (Trim whitespace)
    - name: "Set Failure Fact"
      ansible.builtin.set_fact:
        # If stdout is undefined/null, default to empty string, then trim whitespace
        pacemaker_failure_text: "{{ crm_mon_output.stdout | default('') | trim }}"

    # 3. CASE A: Handle EMPTY Output (No Failures)
    - name: "Report System Health"
      ansible.builtin.debug:
        msg: "No resource failures detected on {{ inventory_hostname }}. System is healthy."
      when: pacemaker_failure_text | length == 0

    # 4. CASE B: Handle FAILURES (Cleanup)
    - name: "Display resource failure summary"
      ansible.builtin.debug:
        msg: 
          - "FAILURE DETECTED on {{ inventory_hostname }}."
          - "Details: {{ pacemaker_failure_text }}"
      when: pacemaker_failure_text | length > 0

    - name: "Execute 'pcs resource cleanup'"
      ansible.builtin.command: pcs resource cleanup
      register: pcs_cleanup_out
      failed_when: pcs_cleanup_out.rc != 0
      # Only run if text length is greater than 0
      when: pacemaker_failure_text | length > 0

    - name: "Display Primary Cleanup Success"
      ansible.builtin.debug:
        msg: "Primary cleanup succeeded."
      when: 
        - pacemaker_failure_text | length > 0
        - pcs_cleanup_out.rc == 0
  rescue:
    # - name: "Execute Secondary Cleanup (crm_resource)"
    #   ansible.builtin.shell: |
    #     # Robust loop to handle multiple failed resources
    #     # We re-run the check command here to get fresh IDs
    #     for resource in $(crm_mon -1 -r | grep -i "failed" | awk '{print $NF}'); do
    #         if [ ! -z "$resource" ]; then
    #             crm_resource --cleanup --resource $resource
    #         fi
    #     done
    #     # Fallback global cleanup
    #     crm_resource --cleanup
    #   register: rescue_cleanup_out

    - name: "Display Rescue Result"
      ansible.builtin.debug:
        msg: "Rescue operation completed. Please verify cluster status."
