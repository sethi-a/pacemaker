---
- name: "Generate Executive Cluster Report"
  run_once: true
  delegate_to: localhost
  block:
    - name: Build Executive Report
      set_fact:
        final_report: |
          =============================================================
          PACEMAKER CLUSTER HEALTH SUMMARY
          =============================================================
          Timestamp: {{ ansible_date_time.iso8601 }}
          Nodes Checked: {{ groups['cluster_nodes'] | length }}
          
          -------------------------------------------------------------
          SCOPE OF CHECKS (LEGEND)
          -------------------------------------------------------------
          [ Local Node Checks ]
            1. Required Variables     2. Service Status (Systemd)
            3. Configuration Files
          
          [ Global Cluster Checks ]
            4. Node Health (PCS)      5. Cluster Properties
            6. Stonith Configuration  7. Failed Resource Actions
            8. Fencing History        9. Split Brain Detection
          
          -------------------------------------------------------------
          LOCAL NODE CHECKS (Sections 1-3)
          -------------------------------------------------------------
          {%- for host in groups['cluster_nodes'] %}
          {%- set host_vars = hostvars[host] | default({}) -%}
          {%- set host_errors = host_vars.get('health_check_errors', []) -%}
          
          {#- Filter for Local Sections (1,2,3) -#}
          {%- set local_issues = [] -%}
          {%- if host_errors is iterable -%}
            {%- for err in host_errors -%}
              {%- if 'SECTION 1' in err or 'SECTION 2' in err or 'SECTION 3' in err -%}
                {{- local_issues.append(err) -}}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
          
          {#- CHECK: Is node unreachable? -#}
          {%- if host not in ansible_play_hosts %}
          [ CRITICAL ] {{ host }} 
             DETAILS: Node Unreachable / SSH Failure
          
          {#- CHECK: Does node have local errors? -#}
          {%- elif local_issues | length > 0 %}
          [ FAILED ]   {{ host }}
            {%- for issue in local_issues %}
             - {{ issue }}
            {%- endfor %}
          
          {#- CHECK: Node is OK -#}
          {%- else %}
          [ OK ]       {{ host }}
          {%- endif %}
          {%- endfor %}

          -------------------------------------------------------------
          GLOBAL CLUSTER HEALTH (Sections 4-9)
          -------------------------------------------------------------
          {%- set primary_node = ansible_play_hosts[0] -%}
          {%- set primary_vars = hostvars[primary_node] | default({}) -%}
          {%- set all_errors = primary_vars.get('health_check_errors', []) -%}
          
          {#- Filter for Global Sections (4,5,6,7,8,9) -#}
          {%- set global_issues = [] -%}
          {%- for err in all_errors -%}
            {%- if 'SECTION 4' in err or 'SECTION 5' in err or 'SECTION 6' in err or 'SECTION 7' in err or 'SECTION 8' in err or 'SECTION 9' in err -%}
              {{- global_issues.append(err) -}}
            {%- endif -%}
          {%- endfor -%}
          
          {%- if global_issues | length == 0 %}
          STATUS: [ OK ] - Cluster properties and status look healthy.
          {%- else %}
          STATUS: [ FAILED ]
          ISSUES:
          {%- for issue in global_issues %}
            - {{ issue }}
          {%- endfor %}
          {%- endif %}
          =============================================================

    - name: Set Cluster Failure Flag
      set_fact:
        cluster_has_failures: "{{ 'STATUS: [ FAILED ]' in final_report or 'CRITICAL' in final_report }}"

    - name: "PRINT SUMMARY REPORT"
      debug:
        msg: "{{ final_report.split('\n') }}"

    - name: Fail Playbook if Critical Errors Exist
      fail:
        msg: "Cluster Health Check Failed. See Report above."
      when: cluster_has_failures | bool