---
- name: "Generate Executive Cluster Report"
  run_once: true
  delegate_to: localhost
  block:
    # -------------------------------------------------------------------
    # STEP 1: SAFEGUARD - ENSURE WE HAVE A NODE FOR GLOBAL DATA
    # -------------------------------------------------------------------
    - name: "Reporting: Determine the Global Reporting Node"
      set_fact:
        # The 'true' flag ensures that if active_cluster_node is an empty string (""), 
        # it still falls back to the first available host.
        report_node: "{{ active_cluster_node | default(ansible_play_hosts[0], true) }}"

    # -------------------------------------------------------------------
    # STEP 2: PRE-PROCESS DATA (No more messy logic inside the text block)
    # -------------------------------------------------------------------
    - name: "Reporting: Extract Global Errors and Status"
      set_fact:
        # Use Regex to cleanly grab ONLY Sections 4 through 8 for global issues
        global_issues: "{{ hostvars[report_node].health_check_errors | default([]) | select('search', 'SECTION [45678]') | list }}"
        
        # Safely get the snapshot, with a helpful error if Section 09 was skipped
        cluster_snapshot: "{{ hostvars[report_node].cluster_status_output | default('Status not captured. (Check if Section 09 failed or skipped on ' ~ report_node ~ ')') }}"

    # -------------------------------------------------------------------
    # STEP 3: BUILD THE REPORT TEXT
    # -------------------------------------------------------------------
    - name: Build Executive Report String
      set_fact:
        final_report: |
          =============================================================
          PACEMAKER CLUSTER HEALTH SUMMARY
          =============================================================
          Timestamp: {{ ansible_date_time.iso8601 }}
          Nodes Checked: {{ groups['cluster_nodes'] | length }}
          
          -------------------------------------------------------------
          LOCAL NODE CHECKS (Sections 1-3)
          -------------------------------------------------------------
          {% for host in groups['cluster_nodes'] %}
          {%- set host_errors = hostvars[host].health_check_errors | default([]) -%}
          {%- set local_issues = host_errors | select('search', 'SECTION [123]') | list -%}
          {% if host not in ansible_play_hosts -%}
          [ CRITICAL ] {{ host }} 
             - DETAILS: Node Unreachable / SSH Failure
          {% elif local_issues | length > 0 -%}
          [ FAILED ]   {{ host }}
          {% for issue in local_issues -%}
             - {{ issue }}
          {% endfor -%}
          {% else -%}
          [ OK ]       {{ host }}
          {% endif -%}
          {% endfor %}
          
          -------------------------------------------------------------
          GLOBAL CLUSTER HEALTH (Sections 4-8)
          -------------------------------------------------------------
          Checked via Node: {{ report_node }}
          
          {% if global_issues | length == 0 -%}
          STATUS: [ OK ] - Cluster properties and status look healthy.
          {% else -%}
          STATUS: [ FAILED ]
          ISSUES:
          {% for issue in global_issues -%}
            - {{ issue }}
          {% endfor -%}
          {% endif %}
          
          -------------------------------------------------------------
          CURRENT CLUSTER STATUS SNAPSHOT (Section 9)
          -------------------------------------------------------------
          {{ cluster_snapshot }}
          =============================================================

    # -------------------------------------------------------------------
    # STEP 4: EVALUATE FAILURE & ALERT
    # -------------------------------------------------------------------
    - name: Set Cluster Failure Flag
      set_fact:
        cluster_has_failures: "{{ 'STATUS: [ FAILED ]' in final_report or 'CRITICAL' in final_report or '[ FAILED ]' in final_report }}"

    - name: "PRINT SUMMARY REPORT"
      debug:
        msg: "{{ final_report.split('\n') }}"

    - name: Fail Playbook if Critical Errors Exist
      fail:
        msg: "Cluster Health Check Failed. See Report above."
      when: cluster_has_failures | bool