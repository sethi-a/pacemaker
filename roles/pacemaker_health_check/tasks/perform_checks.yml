
# -------------------------------------------------------
# SECTION 1: VARIABLE VALIDATION
# -------------------------------------------------------
- name: "SECTION 1: Verification of Required Variables"
  block:
    - name: Assert Variables are defined
      ansible.builtin.assert:
        that:
          - pacemaker_service is defined
          - corosync_service is defined
        fail_msg: "Required variables for service names are missing."
      register: var_check_result
      ignore_errors: true

    - name: Record Variable Failures
      set_fact:
        health_check_errors: "{{ health_check_errors | default([]) + ['SECTION 1: ' + item.msg] }}"
      loop: "{{ var_check_result.results | default([]) }}"
      loop_control:
        label: "{{ item.item }}"
      when: item.failed | bool
# -------------------------------------------------------
# SECTION 2: SERVICE STATUS
# -------------------------------------------------------
- name: "SECTION 2: Verify Service Status"
  block:
    - name: Populate service facts
      ansible.builtin.service_facts:

    - name: Assert Services are Running
      ansible.builtin.assert:
        that:
          - "(item + '.service') in ansible_facts.services"
          - "ansible_facts.services[item + '.service'].state == 'running'"
        fail_msg: "Service '{{ item }}' is not running."
      loop:
        - "{{ pacemaker_service }}"
        - "{{ corosync_service }}"
      register: service_check_result
      ignore_errors: true

    - name: Record Service Failures
      set_fact:
        health_check_errors: "{{ health_check_errors | default([]) + ['SECTION 2: ' + item.msg] }}"
      loop: "{{ service_check_result.results | default([])}}"
      loop_control:
        label: "{{ item.item }}"
      when: item.failed | bool

# -------------------------------------------------------
# SECTION 3: CONFIGURATION FILES
# -------------------------------------------------------
- name: "SECTION 3: Verify Configuration Files"
  block:
    - name: Check existence of configuration files
      ansible.builtin.stat:
        path: "{{ item }}"
      register: config_files
      loop:
        - "{{ corosync_conf_path }}"
        - "{{ cib_xml_path }}"
      ignore_errors: true

    - name: Assert Configuration files exist
      ansible.builtin.assert:
        that: item.stat.exists
        fail_msg: "Configuration file {{ item.item }} is missing."
      loop: "{{ config_files.results | default([]) }}"
      loop_control:
        label: "{{ item.item }}"
      register: file_check_result
      ignore_errors: true

    - name: Record File Failures
      set_fact:
        health_check_errors: "{{ health_check_errors | default([]) + ['SECTION 3: ' + item.msg] }}"
      loop: "{{ file_check_result.results | default([]) }}"
      loop_control:
        label: "{{ item.item.item }}" # Nested item structure due to previous loop
      when: item.failed | bool

# -------------------------------------------------------
# SECTION 4: NODE HEALTH
# -------------------------------------------------------
- name: "SECTION 4: Cluster Node Health Check"
  block:
    - name: Get Cluster Status (PCS)
      command: pcs status
      register: pcs_status
      changed_when: false
      ignore_errors: true

    - name: Record Critical PCS Failure
      set_fact:
        health_check_errors: "{{ health_check_errors | default([]) + ['SECTION 4: Critical - Unable to retrieve cluster status. Error: ' + pcs_status.stderr | default('Command failed')] }}"
      when: pcs_status.failed | bool

    - name: Assert Node Health States
      assert:
        that:
          - "item.pattern not in pcs_status.stdout | default([])"
        fail_msg: "{{ item.msg }}"
      loop:
        - { pattern: 'Standby:', msg: 'One or more nodes are in Standby mode.' }
        - { pattern: 'OFFLINE:', msg: 'One or more nodes are OFFLINE.' }
        - { pattern: 'UNCLEAN',  msg: 'One or more nodes are UNCLEAN.' }
      register: node_health_results
      ignore_errors: true
      when: 
        - not pcs_status.failed | bool
        - pcs_status.stdout is defined

    - name: Record Node Health Failures
      set_fact:
        health_check_errors: "{{ health_check_errors | default([]) + ['SECTION 4: ' + item.msg] }}"
      loop: "{{ node_health_results.results | default([]) }}"
      loop_control:
        label: "{{ item.item.pattern }}"
      when: 
        - not pcs_status.failed | bool
        - item.failed | bool

# -------------------------------------------------------
# SECTION 5: GLOBAL PROPERTIES
# -------------------------------------------------------
- name: "SECTION 5: Verify Global Properties"
  block:
    - name: Get Cluster Properties
      command: pcs property show --all
      register: pcs_properties
      changed_when: false
      ignore_errors: true

    - name: Record Properties Command Failure
      set_fact:
        health_check_errors: "{{ health_check_errors | default([]) + ['SECTION 5: Unable to retrieve properties. Error: ' + pcs_properties.stderr | default('Command failed')] }}"
      when: pcs_properties is not defined or (pcs_properties.failed is defined and pcs_properties.failed)

    - name: Assert Required Properties Exist
      assert:
        that:
          - "item.pattern in pcs_properties.stdout"
        fail_msg: "{{ item.msg }}"
      loop:
        - { pattern: 'stonith-enabled: true', msg: 'CRITICAL: stonith-enabled is NOT set to true.' }
      register: prop_exist_results
      ignore_errors: true
      when:
        - pcs_properties is defined
        - not (pcs_properties.failed | default(false))
        - pcs_properties.stdout is defined

    - name: Assert Forbidden Properties Absent
      assert:
        that:
          - "item.pattern not in pcs_properties.stdout"
        fail_msg: "{{ item.msg }}"
      loop:
        - { pattern: 'maintenance-mode: true', msg: 'WARNING: Cluster is in Maintenance Mode.' }
      register: prop_absent_results
      ignore_errors: true
      when:
        - pcs_properties is defined
        - not (pcs_properties.failed | default(false))
        - pcs_properties.stdout is defined

    - name: Record Property Failures
      set_fact:
        health_check_errors: "{{ health_check_errors | default([]) + ['SECTION 5: ' + item.msg] }}"
      # Loop over both result lists safely
      loop: "{{ (prop_exist_results.results | default([])) + (prop_absent_results.results | default([])) }}"
      loop_control:
        label: "{{ item.item.msg }}"
      when: 
        - item.failed is defined
        - item.failed | bool