
# -------------------------------------------------------
# SECTION 1: VARIABLE VALIDATION
# -------------------------------------------------------
- name: "SECTION 1: Verification of Required Variables"
  block:
    - name: Assert Variables are defined
      ansible.builtin.assert:
        that:
          - pacemaker_service is defined
          - corosync_service is defined
        fail_msg: "Required variables for service names are missing."
  rescue:
    - name: Record Failure (Section 1)
      set_fact:
        health_check_errors: "{{ health_check_errors + ['SECTION 1: ' + ansible_failed_result.msg] }}"
        
# -------------------------------------------------------
# SECTION 2: SERVICE STATUS
# -------------------------------------------------------
- name: "SECTION 2: Verify Service Status"
  block:
    - name: Populate service facts
      ansible.builtin.service_facts:

    - name: Assert Services are Running
      ansible.builtin.assert:
        that:
          - "(item + '.service') in ansible_facts.services"
          - "ansible_facts.services[item + '.service'].state == 'running'"
        fail_msg: "Service '{{ item }}' is not running."
      loop:
        - "{{ pacemaker_service }}"
        - "{{ corosync_service }}"
  rescue:
    - name: Record Failure (Section 2)
      ansible.builtin.set_fact:
        health_check_errors: "{{ health_check_errors + ['SECTION 2: ' + ansible_failed_result.msg] }}"

# -------------------------------------------------------
# SECTION 3: CONFIGURATION FILES
# -------------------------------------------------------
- name: "SECTION 3: Verify Configuration Files"
  block:
    - name: Check existence of configuration files
      ansible.builtin.stat:
        path: "{{ item }}"
      register: config_files
      loop:
        - "{{ corosync_conf_path }}"
        - "{{ cib_xml_path }}"

    - name: Assert Configuration files exist
      ansible.builtin.assert:
        that: item.stat.exists
        fail_msg: "Configuration file {{ item.item }} is missing."
      loop: "{{ config_files.results }}"
      loop_control:
        label: "{{ item.item }}"
  rescue:
    - name: Record Failure (Section 3)
      ansible.builtin.set_fact:
        health_check_errors: "{{ health_check_errors + ['SECTION 3: ' + ansible_failed_result.msg] }}"

# -------------------------------------------------------
# SECTION 4: NODE HEALTH
# -------------------------------------------------------
- name: "SECTION 4: Cluster Node Health Check"
  block:
    - name: Get Cluster Status (PCS)
      command: pcs status
      register: pcs_status
      changed_when: false

    - name: Assert Nodes Healthy
      ansible.builtin.assert:
        that:
          - "'Standby:' not in pcs_status.stdout"
          - "'OFFLINE:' not in pcs_status.stdout"
          - "'UNCLEAN' not in pcs_status.stdout"
        fail_msg: "Nodes are in Standby, Offline, or Unclean state."
  rescue:
    - name: Record Failure (Section 4)
      ansible.builtin.set_fact:
        health_check_errors: "{{ health_check_errors + ['SECTION 4: ' + ansible_failed_result.msg] }}"

- name: "Debug: Verify Captured Errors on Node"
  debug:
    msg: "Node {{ inventory_hostname }} has {{ health_check_errors | length }} errors: {{ health_check_errors }}"
