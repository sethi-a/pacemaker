
# -------------------------------------------------------
# SECTION 1: VARIABLE VALIDATION
# -------------------------------------------------------
- name: "SECTION 1: Verification of Required Variables"
  block:
    - name: Assert Variables are defined
      ansible.builtin.assert:
        that:
          - pacemaker_service is defined
          - corosync_service is defined
        fail_msg: "Required variables for service names are missing."
      register: var_check_result
      ignore_errors: true

    - name: Record Variable Failures
      set_fact:
        health_check_errors: "{{ health_check_errors | default([]) + ['SECTION 1: ' + item.msg] }}"
      loop: "{{ var_check_result.results | default([]) }}"
      loop_control:
        label: "{{ item.item }}"
      when: item.failed | bool
# -------------------------------------------------------
# SECTION 2: SERVICE STATUS
# -------------------------------------------------------
- name: "SECTION 2: Verify Service Status"
  block:
    - name: Populate service facts
      ansible.builtin.service_facts:

    - name: Assert Services are Running
      ansible.builtin.assert:
        that:
          - "(item + '.service') in ansible_facts.services"
          - "ansible_facts.services[item + '.service'].state == 'running'"
        fail_msg: "Service '{{ item }}' is not running."
      loop:
        - "{{ pacemaker_service }}"
        - "{{ corosync_service }}"
      register: service_check_result
      ignore_errors: true

    - name: Record Service Failures
      set_fact:
        health_check_errors: "{{ health_check_errors | default([]) + ['SECTION 2: ' + item.msg] }}"
      loop: "{{ service_check_result.results | default([])}}"
      loop_control:
        label: "{{ item.item }}"
      when: item.failed | bool

# -------------------------------------------------------
# SECTION 3: CONFIGURATION FILES
# -------------------------------------------------------
- name: "SECTION 3: Verify Configuration Files"
  block:
    - name: Check existence of configuration files
      ansible.builtin.stat:
        path: "{{ item }}"
      register: config_files
      loop:
        - "{{ corosync_conf_path }}"
        - "{{ cib_xml_path }}"

    - name: Assert Configuration files exist
      ansible.builtin.assert:
        that: item.stat.exists
        fail_msg: "Configuration file {{ item.item }} is missing."
      loop: "{{ config_files.results | default([]) }}"
      loop_control:
        label: "{{ item.item }}"
      register: file_check_result
      ignore_errors: true

    - name: Record File Failures
      set_fact:
        health_check_errors: "{{ health_check_errors | default([]) + ['SECTION 3: ' + item.msg] }}"
      loop: "{{ file_check_result.results | default([]) }}"
      loop_control:
        label: "{{ item.item.item }}" # Nested item structure due to previous loop
      when: item.failed | bool

# -------------------------------------------------------
# SECTION 4: NODE HEALTH
# -------------------------------------------------------
- name: "SECTION 4: Cluster Node Health Check"
  block:
    - name: Get Cluster Status (PCS)
      command: pcs status
      register: pcs_status
      changed_when: false

    - name: Assert Node Health States
      assert:
        that:
          # We fail if the 'pattern' exists in the stdout
          - "item.pattern not in pcs_status.stdout"
        fail_msg: "{{ item.msg }}"
      loop:
        - { pattern: 'Standby:', msg: 'One or more nodes are in Standby mode.' }
        - { pattern: 'OFFLINE:', msg: 'One or more nodes are OFFLINE.' }
        - { pattern: 'UNCLEAN',  msg: 'One or more nodes are UNCLEAN.' }
      register: node_health_results
      ignore_errors: true

    - name: Record Node Health Failures
      set_fact:
        health_check_errors: "{{ health_check_errors | default([]) + ['SECTION 4: ' + item.msg] }}"
      loop: "{{ node_health_results.results | default([]) }}"
      loop_control:
        label: "{{ item.item.pattern }}"
      when: item.failed | bool