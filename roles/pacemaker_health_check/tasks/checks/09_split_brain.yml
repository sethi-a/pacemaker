---
- name: "SECTION 9: Split Brain Detection"
  when: inventory_hostname == active_cluster_node
  block:
    - name: Get DC Name
      shell: pcs status | grep "Current DC:" | awk '{print $3}'
      register: current_dc_node
      changed_when: false
      ignore_errors: true

    - name: Assert Consensus on DC
      ansible.builtin.assert:
        that:
          - >-
            ansible_play_hosts 
            | map('extract', hostvars, ['current_dc_node', 'stdout']) 
            | select('defined')
            | unique 
            | list 
            | count == 1
        fail_msg: "Split Brain Detected: Nodes see different DCs (or DC is unknown)."
      register: split_brain_result
      ignore_errors: true
      
    - name: Record Split Brain Failure
      ansible.builtin.set_fact:
        health_check_errors: "{{ health_check_errors | default([]) + ['SECTION 9: ' + split_brain_result.msg] }}"
      when: 
        - split_brain_result.failed is defined
        - split_brain_result.failed | bool
