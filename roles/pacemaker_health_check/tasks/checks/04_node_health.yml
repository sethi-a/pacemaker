---
# -------------------------------------------------------
# SECTION 4: NODE HEALTH
# -------------------------------------------------------
- name: "SECTION 4: Cluster Node Health Check"
  block:
    - name: Get Cluster Status (PCS)
      command: pcs status
      register: pcs_status
      changed_when: false
      ignore_errors: true

    - name: Record Critical PCS Failure
      set_fact:
        health_check_errors: "{{ health_check_errors | default([]) + ['SECTION 4: Critical - Unable to retrieve cluster status. Error: ' + pcs_status.stderr | default('Command failed')] }}"
      when: pcs_status.failed | bool

    - name: print the output
      debug:
        msg: "{{ pcs_status.stdout | default('') }}"
      ignore_errors: true

    - name: Assert Node Health States
      assert:
        that:
          - "item.pattern not in pcs_status.stdout | default([])"
        fail_msg: "{{ item.msg }}"
      loop:
        - { pattern: 'standby:', msg: 'One or more nodes are in Standby mode.' }
        - { pattern: 'OFFLINE:', msg: 'One or more nodes are OFFLINE.' }
        - { pattern: 'UNCLEAN',  msg: 'One or more nodes are UNCLEAN.' }
      register: node_health_results
      ignore_errors: true
      when: 
        - not pcs_status.failed | bool
        - pcs_status.stdout is defined

    - name: Record Node Health Failures
      set_fact:
        health_check_errors: "{{ health_check_errors | default([]) + ['SECTION 4: ' + item.msg] }}"
      loop: "{{ node_health_results.results | default([]) }}"
      loop_control:
        label: "{{ item.item.pattern }}"
      when: 
        - not pcs_status.failed | bool
        - item.failed | bool
