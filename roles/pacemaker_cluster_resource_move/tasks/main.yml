- name: Managed Pacemaker Cluster Migration
  block:
    - name: Initialize Tracking
      set_fact:
        migration_summary: []
        rollback_triggered: false

    - name: Execute Migration Loop
      include_tasks: migrate_item.yml
      loop: "{{ cluster_migration_list }}"
      loop_control:
        loop_var: current_item
      when: not rollback_triggered

  rescue:
    - name: "GLOBAL ROLLBACK INITIATED"
      set_fact:
        rollback_triggered: true

    - name: "Revert successful moves to original nodes"
      include_tasks: rollback_item.yml
      loop: "{{ migration_summary }}"
      loop_control:
        loop_var: recovery_item
      when: recovery_item.status == 'SUCCESS'

  always:
    - name: "FINAL MIGRATION REPORT"
      debug:
        msg: 
          - "============================================"
          - "      CLUSTER RESOURCE MIGRATION REPORT     "
          - "============================================"
          - "Target Node: {{ target_node }}"
          - "Outcome: {{ 'FAILED - ROLLED BACK' if rollback_triggered else 'SUCCESS' }}"
          - "--------------------------------------------"
          {% for r in migration_summary %}
          - "Resource: {{ r.resource }}"
          - "Status:   {{ r.status }}"
          - "Notes:    {{ r.notes }}"
          - "--------------------------------------------"
          {% endfor %}

    - name: Post-Operation Cluster Health Validation
      # Ensures no resources are in 'unmanaged' or 'blocked' states
      shell: "crm_resource --list | grep -E 'unmanaged|blocked|failed'"
      register: cluster_health_final
      failed_when: false
      changed_when: false

    - name: Report Post-Op Health
      debug:
        msg: "WARNING: Cluster shows unmanaged or failed resources post-operation!"
      when: cluster_health_final.stdout != ""

    - name: Exit with Failure if Rollback occurred
      fail:
        msg: "Playbook failed. Services were rolled back to maintain integrity."
      when: rollback_triggered | bool
