---
- name: Managed Pacemaker Cluster Migration
  block:
    - name: Initialize Tracking Facts
      set_fact:
        migration_summary: []
        rollback_triggered: false

    - name: Execute Migration Loop
      include_tasks: migrate_item.yml
      loop: "{{ cluster_migration_list }}"
      loop_control:
        loop_var: current_item
      when: not rollback_triggered

  rescue:
    - name: Set Rollback State
      set_fact:
        rollback_triggered: true

    - name: GLOBAL ROLLBACK - Reverting Successful Moves
      include_tasks: rollback_item.yml
      loop: "{{ migration_summary }}"
      loop_control:
        loop_var: recovery_item
      when: recovery_item.status == 'SUCCESS'

  always:
    - name: "FINAL MIGRATION REPORT"
      vars:
        report_content: |
          ============================================
                CLUSTER RESOURCE MIGRATION REPORT     
          ============================================
          Target Node: {{ target_node }}
          Final Outcome: {{ 'FAILED - ROLLED BACK' if rollback_triggered else 'SUCCESS' }}
          Timestamp: {{ ansible_date_time.iso8601 }}
          --------------------------------------------
          {% for r in migration_summary %}
          Resource: {{ r.resource }}
          Status:   {{ r.status }}
          From:     {{ r.from_node }}
          Notes:    {{ r.notes }}
          --------------------------------------------
          {% endfor %}
      debug:
        msg: "{{ report_content.splitlines() }}"

    - name: Post-Operation Cluster Health Validation
      shell: "crm_resource --list | grep -E 'unmanaged|blocked|failed'"
      register: cluster_health_final
      failed_when: false
      changed_when: false

    - name: Alert on Unhealthy Post-Op State
      debug:
        msg: "CRITICAL: Cluster shows unmanaged or failed resources!"
      when: cluster_health_final.stdout != ""

    - name: Fail Playbook if Errors Occurred
      fail:
        msg: "Migration failed. Cluster was rolled back to original state."
      when: rollback_triggered | bool
