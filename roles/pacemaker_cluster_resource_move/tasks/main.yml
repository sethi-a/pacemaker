---
- name: "Election: Check Pacemaker Service Status (All Nodes)"
  command: systemctl is-active pacemaker
  register: pacemaker_service_check
  changed_when: false
  failed_when: false
  check_mode: false # Always run this, even in --check mode

- name: "Election: Designate Active Node"
  run_once: true
  set_fact:
    active_cluster_node: "{{ item }}"
  loop: "{{ ansible_play_hosts }}"
  when:
    - active_cluster_node is not defined
    - "hostvars[item]['pacemaker_service_check'].rc == 0"

- name: "Election: Safety Fallback"
  run_once: true
  set_fact:
    active_cluster_node: "{{ ansible_play_hosts[0] }}"
    active_node_election_failed: true
  when: active_cluster_node is not defined

- name: "Election: Debug Winner"
  run_once: true
  debug:
    msg: "Selected Active Node: {{ active_cluster_node }}"

- name: Managed Pacemaker Cluster Migration
  when: inventory_hostname == active_cluster_node
  block:
    - name: Initialize Tracking Facts
      set_fact:
        migration_summary: []
        rollback_triggered: false

    - name: Execute Migration Loop
      include_tasks: migrate_item.yml
      loop: "{{ cluster_migration_list }}"
      loop_control:
        loop_var: current_item
      when: not rollback_triggered

  rescue:
    - name: Set Rollback State
      set_fact:
        rollback_triggered: true

    - name: GLOBAL ROLLBACK - Reverting MIGRATED Moves
      include_tasks: rollback_item.yml
      loop: "{{ migration_summary }}"
      loop_control:
        loop_var: recovery_item
      when: recovery_item.status == 'MIGRATED'

  always:
    - name: "FINAL MIGRATION REPORT"
      vars:
        report_content: |
          ============================================
                CLUSTER RESOURCE MIGRATION REPORT     
          ============================================
          Target Node:   {{ target_node }}
          Final Outcome: {{ 'FAILED - ROLLED BACK' if rollback_triggered else 'SUCCESS' }}
          Timestamp:     {{ ansible_date_time.iso8601 }}
          --------------------------------------------
          {% for r in migration_summary %}
          Resource: {{ r.resource }}
          Status:   {{ r.status }}
          From:     {{ r.from_node }}
          Notes:    {{ r.notes }}
          --------------------------------------------
          {% endfor %}
      debug:
        msg: "{{ report_content.splitlines() }}"

    - name: Fail Playbook if Errors Occurred
      fail:
        msg: "Migration failed. Services were rolled back."
      when: rollback_triggered | bool
