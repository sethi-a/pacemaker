---
- name: "Rollback: {{ recovery_item.resource }} back to {{ recovery_item.from_node }}"
  block:
    - name: "Execute Move back to {{ recovery_item.from_node }}"
      command: "crm_resource --resource {{ recovery_item.resource }} -M --node {{ recovery_item.from_node }}"

    - name: "Wait for restoration on {{ recovery_item.from_node }}"
      shell: "crm_resource --resource {{ recovery_item.resource }} --locate | grep {{ recovery_item.from_node }}"
      register: restore_check
      until: "recovery_item.from_node in restore_check.stdout"
      retries: "{{ (move_timeout / 5) | int }}"
      delay: 5

    - name: "Clear ban on original node"
      # This restores the cluster to its original failover policy
      command: "crm_resource --resource {{ recovery_item.resource }} --clear --node {{ recovery_item.from_node }}"

    - name: "Update summary to reflect Rollback Success"
      set_fact:
        migration_summary: >-
          {% set new_list = [] %}
          {% for item in migration_summary %}
            {% if item.resource == recovery_item.resource %}
              {% set _ = new_list.append(item | combine({'status': 'ROLLED_BACK', 'notes': 'Successfully reverted to original node'})) %}
            {% else %}
              {% set _ = new_list.append(item) %}
            {% endif %}
          {% endfor %}
          {{ new_list }}

  rescue:
    - name: "Update summary to reflect Rollback Failure"
      set_fact:
        migration_summary: >-
          {% set new_list = [] %}
          {% for item in migration_summary %}
            {% if item.resource == recovery_item.resource %}
              {% set _ = new_list.append(item | combine({'status': 'ROLLBACK_FAILED', 'notes': 'CRITICAL: Failed to return to original node'})) %}
            {% else %}
              {% set _ = new_list.append(item) %}
            {% endif %}
          {% endfor %}
          {{ new_list }}
