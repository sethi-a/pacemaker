---
# tasks/main.yml

# 1. Verification of required variables
- name: Verify required variables are defined
  ansible.builtin.assert:
    that:
      - target_state is defined
    fail_msg: "The variable 'target_state' must be defined (e.g., Started, Stopped)."

# 2. Retrieve Configuration
- name: Retrieve raw Pacemaker resource configuration
  command: pcs resource config
  register: pcs_config_raw
  changed_when: false
  failed_when: pcs_config_raw.rc != 0

- name: Parse resource IDs from configuration
  ansible.builtin.set_fact:
    pacemaker_resources: "{{ pcs_config_raw.stdout | regex_findall('^\\s*(?:Resource|Group):\\s+([\\w-]+)', multiline=True) }}"

# 3. SAFETY CHECK
- name: Fail if no resources were found
  ansible.builtin.fail:
    msg: "Error: No resources detected. The cluster might be empty."
  when: pacemaker_resources | length == 0

# 4. SUMMARY
- name: Display summary of identified resources
  ansible.builtin.debug:
    msg: 
      - "Identified {{ pacemaker_resources | length }} resources."
      - "List: {{ pacemaker_resources }}"

# 5. BULK VERIFICATION
- name: "Wait until ALL resources are {{ target_state }}"
  ansible.builtin.shell: |
    # 1. Determine the exit code we expect from crm_resource
    # If target is Started, we expect code 0 (Running). 
    # If target is Stopped, we expect code 1 (Not Running).
    if [ "{{ target_state }}" == "Started" ]; then 
      EXPECTED_RC=0
    else 
      EXPECTED_RC=1
    fi

    # 2. Iterate through resources LOCALLY on the server
    # This happens inside one SSH session, so it is fast and stable.
    for res in {{ pacemaker_resources | join(' ') }}; do
      
      # --locate asks: "Is this resource running anywhere?"
      # It returns 0 if Yes, 1 if No.
      crm_resource --resource "$res" --locate > /dev/null 2>&1
      ACTUAL_RC=$?

      # 3. Validation Logic
      if [ $ACTUAL_RC -ne $EXPECTED_RC ]; then
        echo "Validating $res... FAILED (Not {{ target_state }})"
        exit 1 # Fail the script. Ansible will wait 'delay' seconds and retry.
      fi
    done

    echo "Success: All resources are {{ target_state }}"
    exit 0
  register: bulk_check
  changed_when: false
  until: bulk_check.rc == 0
  retries: 20   # 20 tries * 10 seconds = ~3.5 minutes timeout
  delay: 10
  ignore_errors: true # The next task handles the final error reporting

# # 6. FINAL REPORTING
# - name: Report verification failure
#   ansible.builtin.fail:
#     msg: "Validation Failed! Not all resources reached '{{ target_state }}'. Please check 'pcs status' manually."
#   when: bulk_check.rc != 0

# # 7. SUCCESS FACTS
# - name: Persist resource status facts
#   ansible.builtin.set_fact:
#     pcmk_verified_resources: "{{ pacemaker_resources }}"
#     pcmk_verification_status: "Success"
#   when: bulk_check.rc == 0
