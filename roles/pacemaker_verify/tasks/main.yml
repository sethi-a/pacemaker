---
# tasks/main.yml

# 1. Verification of required variables
- name: Verify required variables are defined
  ansible.builtin.assert:
    that:
      - target_state is defined
    fail_msg: "The variable 'target_state' must be defined (e.g., Started, Stopped)."

# 2. Retrieve Configuration
- name: Retrieve raw Pacemaker resource configuration
  command: pcs resource config
  register: pcs_config_raw
  changed_when: false
  failed_when: pcs_config_raw.rc != 0

- name: Parse resource IDs from configuration
  ansible.builtin.set_fact:
    pacemaker_resources: "{{ pcs_config_raw.stdout | regex_findall('^\\s*(?:Resource|Group):\\s+([\\w-]+)', multiline=True) }}"

# 3. Don't proceed if no resources detected.
- name: Fail if no resources were found
  ansible.builtin.fail:
    msg: "Error: No resources detected. The cluster might be empty."
  when: pacemaker_resources | length == 0

# 4. SUMMARY
- name: Display summary of identified resources
  ansible.builtin.debug:
    msg: 
      - "Identified {{ pacemaker_resources | length }} resources."
      - "List: {{ pacemaker_resources }}"

# 4. Final Verification Loop
- name: Verify specific resource states
  command: 
    cmd: crm_resource --resource {{ item }} --locate
  loop: "{{ pacemaker_resources }}"
  register: resource_wait
  changed_when: false
  until: resource_wait.rc == 0
  retries: 20   # 20 retries
  delay: 6      # 6 seconds delay
  failed_when: false

# 5. Fail if any resource is in Stopped State
- name: Fail if any resource is not in the correct state
  ansible.builtin.fail:
    msg: "Resource '{{ item.item }}' is NOT {{ target_state }}."
  loop: "{{ resource_wait.results }}"
  # If we want it 'Started', we fail if rc != 0 (because rc=1 means stopped)
  when: 
    - item.rc != 0

