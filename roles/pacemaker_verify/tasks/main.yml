---
# tasks/main.yml

# 1. Verification of required variables
- name: Verify required variables are defined
  ansible.builtin.assert:
    that:
      - target_state is defined
    fail_msg: "The variable 'target_state' must be defined (e.g., Started, Stopped)."

# 2. Retrieve Configuration
- name: Retrieve raw Pacemaker resource configuration
  command: pcs resource config
  register: pcs_config_raw
  changed_when: false
  failed_when: pcs_config_raw.rc != 0

- name: Parse resource IDs from configuration
  ansible.builtin.set_fact:
    pacemaker_resources: "{{ pcs_config_raw.stdout | regex_findall('^\\s*(?:Resource|Group):\\s+([\\w-]+)', multiline=True) }}"

# 3. SAFETY CHECK
- name: Fail if no resources were found
  ansible.builtin.fail:
    msg: "Error: No resources detected. The cluster might be empty."
  when: pacemaker_resources | length == 0

# 4. SUMMARY
- name: Display summary of identified resources
  ansible.builtin.debug:
    msg: 
      - "Identified {{ pacemaker_resources | length }} resources."
      - "List: {{ pacemaker_resources }}"

# 5. BULK VERIFICATION
- name: "Wait until ALL resources are {{ target_state }}"
  ansible.builtin.shell: |
    for res in {{ pacemaker_resources | join(' ') }}; do
      if [ "{{ target_state }}" == "Started" ]; then
        crm_resource --resource "$res" --locate > /dev/null 2>&1 || exit 1
      else
        ! crm_resource --resource "$res" --locate > /dev/null 2>&1 || exit 1
      fi
    done
    exit 0
  register: bulk_check
  changed_when: false
  become: true
  until: bulk_check.rc is defined and bulk_check.rc == 0
  retries: 20
  delay: 10
  ignore_errors: true

# # 6. FINAL REPORTING
# - name: Report verification failure
#   ansible.builtin.fail:
#     msg: "Validation Failed! Not all resources reached '{{ target_state }}'. Please check 'pcs status' manually."
#   when: bulk_check.rc != 0

# # 7. SUCCESS FACTS
# - name: Persist resource status facts
#   ansible.builtin.set_fact:
#     pcmk_verified_resources: "{{ pacemaker_resources }}"
#     pcmk_verification_status: "Success"
#   when: bulk_check.rc == 0
