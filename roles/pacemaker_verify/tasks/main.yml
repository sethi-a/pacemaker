---
# tasks/main.yml

# 1. Verification of required variables
- name: Verify required variables are defined
  ansible.builtin.assert:
    that:
      - target_state is defined
    fail_msg: "The variable 'target_state' must be defined (e.g., Started, Stopped)."

# 2. Retrieve Configuration
- name: Retrieve raw Pacemaker resource configuration
  command: pcs resource config
  register: pcs_config_raw
  changed_when: false
  failed_when: pcs_config_raw.rc != 0

- name: Parse resource IDs from configuration
  ansible.builtin.set_fact:
    pacemaker_resources: "{{ pcs_config_raw.stdout | regex_findall('^\\s*(?:Resource|Group):\\s+([\\w-]+)', multiline=True) }}"

# 3. SAFETY CHECK
- name: Fail if no resources were found
  ansible.builtin.fail:
    msg: "Error: No resources detected. The cluster might be empty."
  when: pacemaker_resources | length == 0

# 4. SUMMARY
- name: Display summary of identified resources
  ansible.builtin.debug:
    msg: 
      - "Identified {{ pacemaker_resources | length }} resources."
      - "List: {{ pacemaker_resources }}"

# 5. Check for status of cluster
- name: "Wait for Cluster to stabilize (Target: {{ target_state }})"
  ansible.builtin.command: pcs status
  register: cluster_status
  changed_when: false
  until: 
    - cluster_status.rc == 0
    - target_state in cluster_status.stdout
  retries: 20   # Wait up to 3+ minutes
  delay: 10     # Check every 10 seconds

# 4. Final Verification Loop
- name: Verify specific resource states
  ansible.builtin.shell: |
    pcs resource show {{ item }} | grep -i "{{ target_state }}"
  loop: "{{ pacemaker_resources }}"
  register: resource_results
  changed_when: false
  ignore_errors: true # We want to see all failures, not stop on the first one

# 5. Reporting
- name: Fail if any resource is not in the correct state
  ansible.builtin.fail:
    msg: "Resource {{ item.item }} is not {{ target_state }}. Output: {{ item.stdout }}"
  loop: "{{ resource_results.results }}"
  when: item.rc != 0

# 6. Success Facts
- name: Set Success Facts
  ansible.builtin.set_fact:
    pcmk_verification_status: "Success"
