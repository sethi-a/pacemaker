---
# tasks/main.yml

# 1. Verification of required variables
- name: Verify required variables are defined
  ansible.builtin.assert:
    that:
      - target_state is defined
    fail_msg: "The variable 'target_state' must be defined (e.g., Started, Stopped)."

# 2. Retrieve Configuration
- name: Retrieve raw Pacemaker resource configuration
  command: pcs resource config
  register: pcs_config_raw
  changed_when: false
  failed_when: pcs_config_raw.rc != 0

- name: Parse resource IDs from configuration
  ansible.builtin.set_fact:
    pacemaker_resources: "{{ pcs_config_raw.stdout | regex_findall('^\\s*(?:Resource|Group):\\s+([\\w-]+)', multiline=True) }}"

# 3. SAFETY CHECK
- name: Fail if no resources were found
  ansible.builtin.fail:
    msg: "Error: No resources detected. The cluster might be empty."
  when: pacemaker_resources | length == 0

# 4. SUMMARY
- name: Display summary of identified resources
  ansible.builtin.debug:
    msg: 
      - "Identified {{ pacemaker_resources | length }} resources."
      - "List: {{ pacemaker_resources }}"

# 4. Final Verification Loop (Safe Method)
- name: Verify specific resource states
  ansible.builtin.command: 
    cmd: pcs resource show {{ item }}
  loop: "{{ pacemaker_resources }}"
  register: resource_check_results
  changed_when: false
  ignore_errors: true

# 5. Reporting (Processing the results)
- name: Fail if any resource is not in the correct state
  ansible.builtin.fail:
    msg: "Resource '{{ item.item }}' failed. Expected '{{ target_state }}'. Got output: {{ item.stdout }}"
  loop: "{{ resource_check_results.results }}"
  when: 
    - item.rc != 0 or target_state not in item.stdout

