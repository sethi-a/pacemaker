---
- name: "Check state of {{ resource_item }}"
  ansible.builtin.shell: |
    # Grep for the resource ID in the status output
    # Then check if the target state (e.g., 'Started') appears on that same line (or generally in the output for that resource)
    pcs status | grep -A 1 "{{ resource_item }}"
  register: resource_check
  changed_when: false
  # Success logic:
  # 1. The grep found the resource (rc=0)
  # 2. The output contains the word 'Started' (or whatever your target_state is)
  until: 
    - resource_check.rc == 0
    - target_state in resource_check.stdout
  retries: "{{ pcmk_retries }}"
  delay: "{{ pcmk_delay }}"
  ignore_errors: true

- name: "Fail if {{ resource_item }} is not {{ target_state }}"
  ansible.builtin.fail:
    msg: "TIMEOUT: Resource {{ resource_item }} did not reach state '{{ target_state }}'. Last Output: {{ resource_check.stdout }}"
  when: 
    - resource_check.rc != 0 or target_state not in resource_check.stdout
