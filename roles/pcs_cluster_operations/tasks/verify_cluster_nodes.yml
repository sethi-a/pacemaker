- name: Get detailed Cluster Status in XML
  command:
    cmd: pcs status xml
  register: cluster_xml_raw
  changed_when: false

- name: Identify specific unhealthy nodes
  ansible.builtin.set_fact:
    offline_node_list: "{{ cluster_xml_raw.stdout | regex_findall('node name=\"([^\"]+)\" [^>]*online=\"false\"') }}"
    standby_node_list: "{{ cluster_xml_raw.stdout | regex_findall('node name=\"([^\"]+)\" [^>]*standby=\"true\"') }}"
    unclean_node_list: "{{ cluster_xml_raw.stdout | regex_findall('node name=\"([^\"]+)\" [^>]*unclean=\"true\"') }}"

- name: Verify Cluster Node Health
  ansible.builtin.assert:
    that:
      - offline_node_list | length == 0
      - standby_node_list | length == 0
      - unclean_node_list | length == 0
    fail_msg: |
      CLUSTER HEALTH ALERT:
      The following nodes are OFFLINE: "{{ offline_node_list | default(['None']) | join(', ') }}"
      The following nodes are in STANDBY: "{{ standby_node_list | default(['None']) | join(', ') }}"
      The following nodes are UNCLEAN/LOST: "{{ unclean_node_list | default(['None']) | join(', ') }}"