---
- name: "Cluster Backup Sequence"
  block:
    # ==========================================
    # PHASE 1: PRE-CHECKS
    # ==========================================
    - name: "1. Verification of required variables"
      ansible.builtin.assert:
        that:
          - cluster_backup_dir is defined
          - cluster_backup_shared_dest is defined
        fail_msg: "Required backup directories are not defined."

    - name: "2. Check shared storage availability"
      ansible.builtin.stat:
        path: "{{ cluster_backup_shared_dest }}"
      when: copy_to_shared_dest
      register: shared_dest_check

    - name: "Fail if shared storage is missing"
      ansible.builtin.fail:
        msg: "Shared destination '{{ cluster_backup_shared_dest }}' is missing."
      when: 
        - copy_to_shared_dest
        - not shared_dest_check.stat.exists or not shared_dest_check.stat.isdir


    # ==========================================
    # PHASE 2: EXECUTION
    # ==========================================
    - name: "Execution Block with Cleanup"
      block:
        - name: "3. Create local temp directory"
          ansible.builtin.file:
            path: "{{ cluster_backup_dir }}"
            state: directory
            mode: '0700'

        - name: "4. Generate timestamps and paths"
          ansible.builtin.set_fact:
            backup_timestamp: "{{ ansible_date_time.date }}_{{ ansible_date_time.hour }}-{{ ansible_date_time.minute }}-{{ ansible_date_time.second }}"
        
        - name: Set file paths
          ansible.builtin.set_fact:
            backup_filename: "{{ cluster_backup_prefix }}_{{ backup_timestamp }}.tar.bz2"
            backup_file_path: "{{ cluster_backup_dir }}/{{ cluster_backup_prefix }}_{{ backup_timestamp }}.tar.bz2"

        - name: "5. Run pcs config backup"
          command:
            cmd: "pcs config backup {{ backup_file_path }}"

        - name: "6. Verify file integrity (tar check)"
          command:
            cmd: "tar -tf {{ backup_file_path }}"
          changed_when: false

        - name: "7. Copy to Shared Storage"
          ansible.builtin.copy:
            src: "{{ backup_file_path }}"
            dest: "{{ cluster_backup_shared_dest }}/{{ backup_filename }}"
            remote_src: yes
            mode: '0640'
          when: copy_to_shared_dest

      # ==========================================
      # ERROR HANDLING: RESCUE
      # ==========================================
      rescue:
        - name: "FAILURE ALERT: Log the failure"
          ansible.builtin.debug:
            msg: "CRITICAL: Cluster backup failed during execution phase on {{ inventory_hostname }}."

        - name: "Fail the play explicitly after rescue"
          ansible.builtin.fail:
            msg: "Stopping playbook due to backup failure."

      # ==========================================
      # CLEANUP: ALWAYS
      # ==========================================
      always:
        - name: "8. Cleanup local temporary file"
          ansible.builtin.file:
            path: "{{ backup_file_path }}"
            state: absent
          when: backup_file_path is defined
          ignore_errors: true # Ensure cleanup doesn't fail the fail
